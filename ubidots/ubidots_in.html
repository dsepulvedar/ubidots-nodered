<script type="text/x-red" data-template-name="ubidots_in">
    <div class="form-row">
        <label for="node-input-tier">
      <i class="fa fa-flag"></i>
      <span data-i18n="ubidots.select_tier"></span>
  </label>
        <select id="node-input-tier">
      <option value="business">Ubidots</option>
      <option value="educational">Ubidots for Education</option>
  </select>
    </div>

    <div class="form-row">
        <label for="node-input-name">
          <i class="fa fa-tag"></i>
      <span data-i18n="ubidots.name"></span>
  </label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]ubidots.name" />
    </div>

    <div class="form-row">
        <label for="node-input-token">
      <i class="fa fa-lock"></i>
      <span data-i18n="ubidots.token.label"></span>
  </label>
        <input type="text" id="node-input-token" data-i18n="[placeholder]ubidots.token.placeholder" />
    </div>

    <div class="form-row">
        <label for="node-input-device_label">
      <i class="fa fa-tag"></i>
      <span data-i18n="ubidots.device_label.label"></span>
  </label>
        <input type="text" id="node-input-device_label" data-i18n="[placeholder]ubidots.device_label.placeholder" />
    </div>
    <div class="form-row">
      <input type="checkbox" checked id="node-input-tls_checkbox_in" style="display: inline-block; width: auto; vertical-align: top;"></label>
      <label for="node-input-tls_checkbox_in" style="width: calc(100% - 170px); margin-left:15px" data-i18n="ubidots.tls.label"></label>
  </div>
  <div class="form-row">
    <input type="checkbox" checked id="node-input-custom_topic_checkbox" style="display: inline-block; width: auto; vertical-align: top;"></label>
    <label for="node-input-custom_topic_checkbox" style="width: calc(100% - 170px); margin-left:15px" data-i18n="ubidots.custom_topics"></label>
</div>
<hr>
    <div class="form-row">
        <label for="node-input-label_variable_1">
      
      <span data-i18n="ubidots.label_variable.label"></span>
  </label>
        <input type="text" id="node-input-label_variable_1" data-i18n="[placeholder]ubidots.label_variable.placeholder" />
    </div>
   
    <!-- DELETE/SELECT ALL BUTTON -->
    <div class="form-row">
        <button id="select-all-variables-button" class="deleteButton" data-i18n="ubidots.variables.selectAll"></button>
        <button id="delete-variables-button" style="margin-left:250px" class="deleteButton" data-i18n="ubidots.variables.delete"></button>
    </div>

    <!-- EXTRA VARIABLES -->
    <div id="variable-2" class="form-row" style="margin-top:10px">
        <input type="checkbox" id="ubidots-checkbox-variable-2" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable_2" style="vertical-align: center">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable2"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable_2" data-i18n="[placeholder]ubidots.variables.placeholder2" />
        <button class="red-ui-button" id="ubidots-variable-button-key-clear-2"><i style="color:#525050;"class="fa fa-times"></i></button>
        <!-- <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-2" style="margin-left: 10px"><i class="fa fa-times"></i></button> -->
    </div>
    <!-- Variable 3 -->
    <div id="variable-3" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-3" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable_3" style="vertical-align: center">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable3"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable_3" data-i18n="[placeholder]ubidots.variables.placeholder3" />
        <button class="red-ui-button" id="ubidots-variable-button-key-clear-3"><i style="color:#525050;"class="fa fa-times"></i></button>
        <!-- <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-3" style="margin-left: 10px"><i class="fa fa-times"></i></button> -->
    </div>
    </div>
    <!-- Variable 4 -->
    <div id="variable-4" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-4" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable_4" style="vertical-align: center">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable4"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable_4" data-i18n="[placeholder]ubidots.variables.placeholder4" />
        <button class="red-ui-button" id="ubidots-variable-button-key-clear-4"><i style="color:#525050;"class="fa fa-times"></i></button>
        <!-- <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-4" style="margin-left: 10px"><i class="fa fa-times"></i></button> -->
    </div>
    </div>
    <!-- Variable 5 -->
    <div id="variable-5" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-5" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable_5">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable5"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable_5" data-i18n="[placeholder]ubidots.variables.placeholder5" />
        <button class="red-ui-button" id="ubidots-variable-button-key-clear-5"><i style="color:#525050;"class="fa fa-times"></i></button>
        <!-- <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-5" style="margin-left: 10px"><i class="fa fa-times"></i></button> -->
    </div>
    </div>
    <!-- Variable 6 -->
    <div id="variable-6" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-6" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable_6">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable6"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable_6" data-i18n="[placeholder]ubidots.variables.placeholder6" />
        <button class="red-ui-button" id="ubidots-variable-button-key-clear-6"><i style="color:#525050;"class="fa fa-times"></i></button>
        <!-- <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-6" style="margin-left: 10px"><i class="fa fa-times"></i></button> -->
    </div>
    </div>
    <!-- Variable 7 -->
    <div id="variable-7" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-7" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable_7">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable7"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable_7" data-i18n="[placeholder]ubidots.variables.placeholder7" />
        <button class="red-ui-button" id="ubidots-variable-button-key-clear-7"><i style="color:#525050;"class="fa fa-times"></i></button>
        <!-- <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-7" style="margin-left: 10px"><i class="fa fa-times"></i></button> -->
    </div>
    </div>
    <!-- Variable 8 -->
    <div id="variable-8" id="variable-8" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-8" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable_8">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable8"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable_8" data-i18n="[placeholder]ubidots.variables.placeholder8" />
        <button class="red-ui-button" id="ubidots-variable-button-key-clear-8"><i style="color:#525050;"class="fa fa-times"></i></button>
        <!-- <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-8" style="margin-left: 10px"><i class="fa fa-times"></i></button> -->
    </div>
    </div>
    <!-- Variable 9 -->
    <div id="variable-9" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-9" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable_9">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable9"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable_9" data-i18n="[placeholder]ubidots.variables.placeholder9" />
        <button class="red-ui-button" id="ubidots-variable-button-key-clear-9"><i style="color:#525050;"class="fa fa-times"></i></button>
        <!-- <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-9" style="margin-left: 10px"><i class="fa fa-times"></i></button> -->
    </div>
    </div>
    <!-- Variable 10 -->
    <div id="variable-10" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-10" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable_10">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable10"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable_10" data-i18n="[placeholder]ubidots.variables.placeholder10" />
        <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-10" style="margin-left: 10px"><i class="fa fa-times"></i></button>
        <!-- <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-10" style="margin-left: 10px"><i class="fa fa-times"></i></button> -->
    </div>
    </div>
    <!-- Add Button -->
    <div id="add-button" class="form-row">
        <label style="width: calc(30%)" for="ubidots-add-variable-button">
            <span data-i18n="ubidots.variables.add"></span>
        </label>

        <span style="width: calc(20%)">
       <button class="red-ui-button" id="ubidots-add-variable-button"><i class="fa fa-plus"></i></button>
    </span>

    </div>
</script>

<script type="text/x-red" data-help-name="ubidots_in">
  <p>Fetch the last value from Ubidots and send it as a message to other nodes.</p>

  <p>
      Uses the <a href="https://github.com/mqttjs/MQTT.js" target="_blank">MQTT</a> to make the connection and suscribe to the channel.
  </p>

  <p>
      You must configure your node by double clicking it and filling the following information, all fields are required:
      <br />

      <ul>
          <li>
              <b>Account type</b> - The type of your account, whether it is a Ubidots or Ubidots for Education account.
          </li>
          <li>
              <b>Name</b> - The name to identify your MQTT client.
          </li>
          <li>
              <b>Token</b> - Your Ubidots' account token. You can find it by following
              <a href="http://help.ubidots.com/user-guides/find-your-token-from-your-ubidots-account" target="_blank">
      this tutorial
  </a>.
          </li>
          <li>
              <b>Device label</b> - The label of the Device that contains the Variable where you want to fetch the values.
          </li>
          <li>
              <b>Variable label</b> - The label of the Variable that you want to fetch the values from.
          </li>
      </ul>
  </p>

  <p>
      Refer to the <a href="https://ubidots.com/docs/api/mqtt.html" target="_blank">Ubidots documentation</a> for more information about the functionality of the MQTT broker.
  </p>
</script>

<script type="text/javascript">
  RED.nodes.registerType("ubidots_in", {
    category: "input",
    color: "#5996F7",
    defaults: {
      tier: {
        value: "business"
      },
      name: {
        value: "",
        required: true
      },
      token: {
        value: "",
        required: true
      },
      device_label: {
        value: ""
      },
      label_variable_1: {
        value: "",
        required: true
      },
      label_variable_2: {
        value: ""
      },
      label_variable_3: {
        value: ""
      },
      label_variable_4: {
        value: ""
      },
      label_variable_5: {
        value: ""
      },
      label_variable_6: {
        value: ""
      },
      label_variable_7: {
        value: ""
      },
      label_variable_8: {
        value: ""
      },
      label_variable_9: {
        value: ""
      },
      label_variable_10: {
        value: ""
      }
    },
    inputs: 0,
    outputs: 1,

    icon: "ubidots.png",
    label: function() {
      return this.name || this.to || "ubidots input";
    },
    labelStyle: function() {
      return this.name ? "node_label_italic" : "";
    },
    oneditcancel: function() {},

    oneditsave: function() {},
    oneditprepare: function() {
      var variablesActivos = [];
      var variablesDesactivados = [2, 3, 4, 5, 6, 7, 8, 9, 10];
      var checkedVariables = [];
      var auxArray = [];
      var genericString = "#variable-";
      var genericCheckBoxString = "#ubidots-checkbox-variable-";

      //hide/show extra variables by default
      for (var h = 2; h < 11; h++) {
        if (!$("#node-input-label_variable_" + h).val()) {
          $("#variable-" + h).hide();
        }
      }
      $("#delete-variables-button").hide();
      $("#select-all-variables-button").hide();

      //Defining checkbox behaviour
      $("#ubidots-checkbox-variable-2").on("click", function() {
        manageCheckBoxes(this, 2);
        showDeleteButton();
      });
      $("#ubidots-checkbox-variable-3").on("click", function() {
        manageCheckBoxes(this, 3);
        showDeleteButton();
      });
      $("#ubidots-checkbox-variable-4").on("click", function() {
        manageCheckBoxes(this, 4);
        showDeleteButton();
      });
      $("#ubidots-checkbox-variable-5").on("click", function() {
        manageCheckBoxes(this, 5);
        showDeleteButton();
      });
      $("#ubidots-checkbox-variable-6").on("click", function() {
        manageCheckBoxes(this, 6);
        showDeleteButton();
      });
      $("#ubidots-checkbox-variable-7").on("click", function() {
        manageCheckBoxes(this, 7);
        showDeleteButton();
      });
      $("#ubidots-checkbox-variable-8").on("click", function() {
        manageCheckBoxes(this, 8);
        showDeleteButton();
      });
      $("#ubidots-checkbox-variable-9").on("click", function() {
        manageCheckBoxes(this, 9);
        showDeleteButton();
      });
      $("#ubidots-checkbox-variable-10").on("click", function() {
        manageCheckBoxes(this, 10);
        showDeleteButton();
      });

      //Defining clear buttons
      $("#ubidots-variable-button-key-clear-2").on("click", function() {
        manageArrays(2);
      });
      $("#ubidots-variable-button-key-clear-3").on("click", function() {
        manageArrays(3);
      });
      $("#ubidots-variable-button-key-clear-4").on("click", function() {
        manageArrays(4);
      });
      $("#ubidots-variable-button-key-clear-5").on("click", function() {
        manageArrays(5);
      });
      $("#ubidots-variable-button-key-clear-6").on("click", function() {
        manageArrays(6);
      });
      $("#ubidots-variable-button-key-clear-7").on("click", function() {
        manageArrays(7);
      });
      $("#ubidots-variable-button-key-clear-8").on("click", function() {
        manageArrays(8);
      });
      $("#ubidots-variable-button-key-clear-9").on("click", function() {
        manageArrays(9);
      });
      $("#ubidots-variable-button-key-clear-10").on("click", function() {
        manageArrays(10);
      });
      $("#ubidots-add-variable-button").on("click", function() {
        var variableIndex = getMinimum(variablesDesactivados);
        var index = variablesDesactivados.indexOf(variableIndex);
        variablesDesactivados.splice(index, 1);
        variablesActivos.push(variableIndex);
        $(genericString + variableIndex.toString()).show();
        showAddButton();
      });

      $("#select-all-variables-button").on("click", function() {
        for (var l = 0; l <= 10; l++) {
          if ($("#variable-" + l).is(":visible")) {
            $(genericCheckBoxString + l.toString()).prop("checked", true);
          }
        }
        $("#select-all-variables-button").attr(
          "data-i18n",
          i18n.t("ubidots.variables.unselectAll")
        );
      });

      $("#delete-variables-button").on("click", function() {
        console.log("Inside Delete Button pressed");
        auxArray = Array.from(checkedVariables);
        for (var i = 0; i < auxArray.length; i++) {
          manageArrays(auxArray[i]);
          emptyFields(auxArray[i]);
        }
        auxArray.splice(0, auxArray.length);
        showDeleteButton();
      });

      function manageCheckBoxes(checkbox, number) {
        if ($(checkbox).is(":checked")) {
          checkedVariables.push(number);
        } else {
          var index = checkedVariables.indexOf(number);
          checkedVariables.splice(index, 1);
        }
      }

      function manageArrays(number) {
        $(genericString + number.toString()).hide();
        variablesDesactivados.push(number);
        var index = variablesActivos.indexOf(number);
        variablesActivos.splice(index, 1);
        var index2 = checkedVariables.indexOf(number);
        checkedVariables.splice(index2, 1);
        emptyFields(number);
        showAddButton();
      }

      function emptyFields(number) {
        $("#node-input-label_variable_" + number.toString()).val("");
        $(genericCheckBoxString + number.toString()).prop("checked", false);
      }

      function showDeleteButton() {
        if (checkedVariables.length > 0) {
          $("#select-all-variables-button").show();
          $("#delete-variables-button").show();
        } else {
          $("#select-all-variables-button").hide();
          $("#delete-variables-button").hide();
        }
      }

      function showAddButton() {
        if (variablesDesactivados.length > 0) {
          $("#add-button").show();
        } else {
          $("#add-button").hide();
        }
      }

      function getMinimum(array) {
        var min = array[0];
        for (var i = 1; i < array.length; i++) {
          if (array[i] < min) {
            min = array[i];
          }
        }
        return min;
      }
    }
  });
</script>

<style>
  .deleteButton {
    color: #494949 !important;
    text-decoration: none;
    background: #ffffff;
    padding: 5px;
    border: 1px solid #cccccc !important;
    display: inline-block;
    transition: all 0.5s ease 0s;
  }

  .deleteButton:hover {
    color: #ffffff !important;
    background: #b4162a;
    border-color: #b4162a !important;
    transition: all 0.4s ease 0s;
  }

  .deleteButton:active {
    color: #ffffff !important;
    background: #8a1222;
    border-color: #8a1222 !important;
    transition: all 0.4s ease 0s;
  }
  .red-ui-button {
    box-shadow: 0 4px 6px 0 rgba(0, 0, 0, 0.1), 0 6px 15px 0 rgba(0, 0, 0, 0.1);
  }
</style>
