<script type="text/x-red" data-template-name="ubidots_in">
    <div class="form-row">
        <label for="node-input-tier">
      <i class="icon-flag"></i>
      <span data-i18n="ubidots.select_tier"></span>
  </label>
        <select id="node-input-tier">
      <option value="business">Ubidots</option>
      <option value="educational">Ubidots for Education</option>
  </select>
    </div>

    <div class="form-row">
        <label for="node-input-name">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.name"></span>
  </label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]ubidots.name" />
    </div>

    <div class="form-row">
        <label for="node-input-token">
      <i class="icon-lock"></i>
      <span data-i18n="ubidots.token.label"></span>
  </label>
        <input type="text" id="node-input-token" data-i18n="[placeholder]ubidots.token.placeholder" />
    </div>

    <div class="form-row">
        <label for="node-input-device_label">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.device_label.label"></span>
  </label>
        <input type="text" id="node-input-device_label" data-i18n="[placeholder]ubidots.device_label.placeholder" />
    </div>

    <div class="form-row">
        <label for="node-input-label_variable">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.label_variable.label"></span>
  </label>
        <input type="text" id="node-input-label_variable" data-i18n="[placeholder]ubidots.label_variable.placeholder" />
    </div>
    <hr>
    <!-- DELETE BUTTON -->
    <div class="button_cont" align="right" style="margin-bottom:10px">
        <button id="delete-variables-button" class="deleteButton" data-i18n="ubidots.variables.delete"></button>
    </div>

    <!-- EXTRA VARIABLES -->
    <div id="variable-2" class="form-row" style="margin-top:10px">
        <input type="checkbox" id="ubidots-checkbox-variable-2" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable2" style="vertical-align: center">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable2"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable2" data-i18n="[placeholder]ubidots.variables.placeholder2" />
        <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-2" style="margin-left: 10px"><i class="fa fa-times"></i></button>
    </div>
    <!-- Variable 3 -->
    <div id="variable-3" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-3" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable3" style="vertical-align: center">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable3"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable3" data-i18n="[placeholder]ubidots.variables.placeholder3" />
        <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-3" style="margin-left: 10px"><i class="fa fa-times"></i></button>
    </div>
    </div>
    <!-- Variable 4 -->
    <div id="variable-4" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-4" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable4" style="vertical-align: center">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable4"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable4" data-i18n="[placeholder]ubidots.variables.placeholder4" />
        <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-4" style="margin-left: 10px"><i class="fa fa-times"></i></button>
    </div>
    </div>
    <!-- Variable 5 -->
    <div id="variable-5" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-5" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable5">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable5"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable5" data-i18n="[placeholder]ubidots.variables.placeholder5" />
        <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-5" style="margin-left: 10px"><i class="fa fa-times"></i></button>
    </div>
    </div>
    <!-- Variable 6 -->
    <div id="variable-6" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-6" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable6">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable6"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable6" data-i18n="[placeholder]ubidots.variables.placeholder6" />
        <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-6" style="margin-left: 10px"><i class="fa fa-times"></i></button>
    </div>
    </div>
    <!-- Variable 7 -->
    <div id="variable-7" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-7" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable7">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable7"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable7" data-i18n="[placeholder]ubidots.variables.placeholder7" />
        <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-7" style="margin-left: 10px"><i class="fa fa-times"></i></button>
    </div>
    </div>
    <!-- Variable 8 -->
    <div id="variable-8" id="variable-8" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-8" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable8">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable8"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable8" data-i18n="[placeholder]ubidots.variables.placeholder8" />
        <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-8" style="margin-left: 10px"><i class="fa fa-times"></i></button>
    </div>
    </div>
    <!-- Variable 9 -->
    <div id="variable-9" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-9" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable9">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable9"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable9" data-i18n="[placeholder]ubidots.variables.placeholder9" />
        <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-9" style="margin-left: 10px"><i class="fa fa-times"></i></button>
    </div>
    </div>
    <!-- Variable 10 -->
    <div id="variable-10" class="form-row">
        <input type="checkbox" id="ubidots-checkbox-variable-10" style="display: inline-block; margin-right:10px; width: auto; vertical-align: center;">
        <label for="node-input-label_variable10">
      <i class="icon-tag"></i>
      <span data-i18n="ubidots.variables.variable10"></span>
  </label>
        <input type="text" style="width: calc(100% - 170px);" id="node-input-label_variable10" data-i18n="[placeholder]ubidots.variables.placeholder10" />
        <button class="red-ui-button red-ui-button-small" id="ubidots-variable-button-key-clear-10" style="margin-left: 10px"><i class="fa fa-times"></i></button>
    </div>
    </div>
    <!-- Add Button -->
    <div id="add-button" class="form-row">
        <label style="width: calc(30%)" for="ubidots-add-variable-button">
            <span data-i18n="ubidots.variables.add"></span>
        </label>

        <span style="width: calc(20%)">
       <button class="red-ui-button" id="ubidots-add-variable-button"><i class="fa fa-plus"></i></button>
    </span>

    </div>
</script>

<script type="text/x-red" data-help-name="ubidots_in">
    <p>Fetch the last value from Ubidots and send it as a message to other nodes.</p>

    <p>
        Uses the <a href="https://github.com/mqttjs/MQTT.js" target="_blank">MQTT</a> to make the connection and suscribe to the channel.
    </p>

    <p>
        You must configure your node by double clicking it and filling the following information, all fields are required:
        <br />

        <ul>
            <li>
                <b>Account type</b> - The type of your account, whether it is a Ubidots or Ubidots for Education account.
            </li>
            <li>
                <b>Name</b> - The name to identify your MQTT client.
            </li>
            <li>
                <b>Token</b> - Your Ubidots' account token. You can find it by following
                <a href="http://help.ubidots.com/user-guides/find-your-token-from-your-ubidots-account" target="_blank">
        this tutorial
    </a>.
            </li>
            <li>
                <b>Device label</b> - The label of the Device that contains the Variable where you want to fetch the values.
            </li>
            <li>
                <b>Variable label</b> - The label of the Variable that you want to fetch the values from.
            </li>
        </ul>
    </p>

    <p>
        Refer to the <a href="https://ubidots.com/docs/api/mqtt.html" target="_blank">Ubidots documentation</a> for more information about the functionality of the MQTT broker.
    </p>
</script>

<script type="text/javascript">
    RED.nodes.registerType("ubidots_in", {
            variableCounter: 1,
            category: "input",
            color: "#5996F7",
            defaults: {
                tier: {
                    value: "business"
                },
                name: {
                    value: ""
                },
                token: {
                    value: ""
                },
                device_label: {
                    value: ""
                },
                label_variable: {
                    value: ""
                }
            },
            inputs: 0,
            outputs: 1,

            icon: "ubidots.png",
            label: function() {
                return this.name || this.to || "ubidots input";
            },
            labelStyle: function() {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function() {
                var variablesActivos = [];
                var variablesDesactivados = [2, 3, 4, 5, 6, 7, 8, 9, 10];
                var checkedVariables = [];
                var auxArray = [];
                var genericString = '#variable-';
                var genericCheckBoxString = '#ubidots-checkbox-variable-';

                //hide all extra variables by default
                $("#delete-variables-button").hide();
                $("#variable-2").hide();
                $("#variable-3").hide();
                $("#variable-4").hide();
                $("#variable-5").hide();
                $("#variable-6").hide();
                $("#variable-7").hide();
                $("#variable-8").hide();
                $("#variable-9").hide();
                $("#variable-10").hide();

                //Defining checkbox behaviour
                $("#ubidots-checkbox-variable-2").on("click", function() {
                    manageCheckBoxes(this, 2);
                    showDeleteButton();
                });
                $("#ubidots-checkbox-variable-3").on("click", function() {
                    manageCheckBoxes(this, 3);
                    showDeleteButton();
                });
                $("#ubidots-checkbox-variable-4").on("click", function() {
                    manageCheckBoxes(this, 4);
                    showDeleteButton();
                });
                $("#ubidots-checkbox-variable-5").on("click", function() {
                    manageCheckBoxes(this, 5);
                    showDeleteButton();
                });
                $("#ubidots-checkbox-variable-6").on("click", function() {
                    manageCheckBoxes(this, 6);
                    showDeleteButton();
                });
                $("#ubidots-checkbox-variable-7").on("click", function() {
                    manageCheckBoxes(this, 7);
                    showDeleteButton();
                });
                $("#ubidots-checkbox-variable-8").on("click", function() {
                    manageCheckBoxes(this, 8);
                    showDeleteButton();
                });
                $("#ubidots-checkbox-variable-9").on("click", function() {
                    manageCheckBoxes(this, 9);
                    showDeleteButton();
                });
                $("#ubidots-checkbox-variable-10").on("click", function() {
                    manageCheckBoxes(this, 10);
                    showDeleteButton();
                });


                //Defining clear buttons
                $("#ubidots-variable-button-key-clear-2").on("click", function() {
                    manageArrays(2);
                });
                $("#ubidots-variable-button-key-clear-3").on("click", function() {
                    manageArrays(3);
                });
                $("#ubidots-variable-button-key-clear-4").on("click", function() {
                    manageArrays(4);
                });
                $("#ubidots-variable-button-key-clear-5").on("click", function() {
                    manageArrays(5);
                });
                $("#ubidots-variable-button-key-clear-6").on("click", function() {
                    manageArrays(6);
                });
                $("#ubidots-variable-button-key-clear-7").on("click", function() {
                    manageArrays(7);
                });
                $("#ubidots-variable-button-key-clear-8").on("click", function() {
                    manageArrays(8);
                });
                $("#ubidots-variable-button-key-clear-9").on("click", function() {
                    manageArrays(9);
                });
                $("#ubidots-variable-button-key-clear-10").on("click", function() {
                    manageArrays(10);
                });
                $("#ubidots-add-variable-button").on("click", function() {
                    var variableIndex = getMinimum(variablesDesactivados);
                    var index = variablesDesactivados.indexOf(variableIndex);
                    variablesDesactivados.splice(index, 1);
                    variablesActivos.push(variableIndex);
                    $(genericString + variableIndex.toString()).show();
                    showAddButton();
                });

                $("#delete-variables-button").on("click", function() {
                    auxArray = Array.from(checkedVariables);
                    for (var i = 0; i < auxArray.length; i++) {
                        manageArrays(auxArray[i]);
                        emptyFields(auxArray[i]);
                    }
                    auxArray.splice(0, auxArray.length);
                    showDeleteButton();
                });



                function manageCheckBoxes(checkbox, number) {
                    if ($(checkbox).is(':checked')) {
                        checkedVariables.push(number);

                    } else {
                        var index = checkedVariables.indexOf(number);
                        checkedVariables.splice(index, 1);
                    };
                }

                function manageArrays(number) {
                    $(genericString + number.toString()).hide();
                    variablesDesactivados.push(number);
                    var index = variablesActivos.indexOf(number);
                    variablesActivos.splice(index, 1);
                    var index2 = checkedVariables.indexOf(number);
                    checkedVariables.splice(index2, 1);
                    emptyFields(number);
                    showAddButton();
                }

                function emptyFields(number) {
                    $("#node-input-label_variable" + number.toString()).val('');
                    $(genericCheckBoxString + number.toString()).prop('checked', false);
                }

                function showDeleteButton() {
                    if (checkedVariables.length > 0) {
                        $("#delete-variables-button").show();
                    } else {
                        $("#delete-variables-button").hide();
                    }
                }

                function showAddButton() {
                    if (variablesDesactivados.length > 0) {
                        $("#add-button").show();
                    } else {
                        $("#add-button").hide();
                    }
                }

                function getMinimum(array) {
                    var min = array[0];
                    for (var i = 1; i < array.length; i++) {
                        if (array[i] < min) {
                            min = array[i];
                        }
                    }
                    return min;
                }
            },

        },

    );
</script>

<style>
    .deleteButton {
        color: #494949 !important;
        text-decoration: none;
        background: #ffffff;
        padding: 5px;
        border: 1px solid #CCCCCC !important;
        display: inline-block;
        transition: all 0.5s ease 0s;
    }
    
    .deleteButton:hover {
        color: #ffffff !important;
        background: #B4162A;
        border-color: #B4162A !important;
        transition: all 0.4s ease 0s;
    }
    
    .deleteButton:active {
        color: #ffffff !important;
        background: #8a1222;
        border-color: #8a1222 !important;
        transition: all 0.4s ease 0s;
    }
</style>